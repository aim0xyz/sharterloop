<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Shatterloop - Aether Drifter</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box;touch-action:manipulation;}
    body{
      font-family:'Segoe UI','Helvetica Neue',sans-serif;
      background:linear-gradient(135deg,#0c0c2d,#000);
      color:#fff;height:100vh;overflow:hidden;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      user-select:none;-webkit-tap-highlight-color:transparent;
    }
    #gameContainer{position:relative;width:100%;max-width:500px;height:100vh;max-height:100vh;overflow:hidden;touch-action:none;}
    #gameCanvas{position:absolute;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at center,#0a0a20,#000 70%);z-index:1;}
    #uiContainer{position:absolute;top:0;left:0;width:100%;height:100%;z-index:10;pointer-events:none;}
    .score-display,.shard-count{position:absolute;font-size:24px;font-weight:bold;text-shadow:0 0 10px #00f3ff,0 0 20px #00f3ff;pointer-events:none;}
    .score-display{top:20px;left:20px;}
    .shard-count{top:20px;right:20px;text-shadow:0 0 10px #f300ff,0 0 20px #f300ff;}
    .time-bend-ui{position:absolute;bottom:30px;left:50%;transform:translateX(-50%);width:80px;height:80px;
      border-radius:50%;background:rgba(0,0,0,0.5);border:2px solid #00f3ff;display:flex;flex-direction:column;
      justify-content:center;align-items:center;pointer-events:auto;touch-action:manipulation;z-index:20;}
    .time-bend-icon{font-size:30px;color:#00f3ff;text-shadow:0 0 10px #00f3ff;}
    .time-bend-counter{position:absolute;bottom:-25px;font-size:18px;font-weight:bold;color:#00f3ff;
      background:rgba(0,0,0,0.5);padding:3px 10px;border-radius:12px;border:1px solid #00f3ff;}
    .time-bend-cooldown{position:absolute;width:100%;height:100%;border-radius:50%;border:5px solid transparent;
      border-top-color:#00f3ff;animation:cooldown 5s linear forwards;opacity:0.7;}
    @keyframes cooldown{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

    /* MENU */
    #menuScreen{
      position:absolute;top:0;left:0;width:100%;height:100%;
      background:linear-gradient(135deg,#0f0c4d,#000);
      display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
      z-index:100;padding:20px;padding-top:5vh;padding-bottom:5vh;
      text-align:center;overflow-y:auto;pointer-events:auto;
    }
    #menuScreen h1{
      font-size:48px;margin-bottom:20px;background:linear-gradient(to right,#00f3ff,#f300ff);
      -webkit-background-clip:text;background-clip:text;color:transparent;
      text-shadow:0 0 20px rgba(0,243,255,0.3);letter-spacing:1px;
    }
    #menuScreen p{font-size:18px;max-width:90%;margin-bottom:30px;color:#aaa;line-height:1.5;}
    .menu-btn{
      background:linear-gradient(to right,#0047ff,#00a2ff);border:none;border-radius:50px;
      color:#fff;font-size:22px;font-weight:bold;padding:15px 40px;margin:15px 0;
      width:80%;max-width:350px;cursor:pointer;transition:all .3s ease;
      box-shadow:0 5px 15px rgba(0,162,255,0.4);letter-spacing:1px;
      pointer-events:auto;touch-action:manipulation;
    }
    .menu-btn:active{transform:scale(.95);box-shadow:0 3px 10px rgba(0,162,255,0.6);}
    .menu-btn.fracture{
      background:linear-gradient(to right,#7b00ff,#f300ff);
      box-shadow:0 5px 15px rgba(243,0,255,0.4);
    }
    .menu-btn.fracture:active{box-shadow:0 3px 10px rgba(243,0,255,0.6);}
    .user-badge{
      position:absolute;top:15px;right:15px;width:40px;height:40px;
      border-radius:50%;background:rgba(20,20,40,0.7);
      display:flex;align-items:center;justify-content:center;font-size:20px;
      cursor:pointer;border:2px solid #00a2ff;pointer-events:auto;
    }

    /* GAME OVER */
    #gameOverScreen{
      position:absolute;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.85);display:none;flex-direction:column;
      align-items:center;justify-content:center;z-index:100;padding:20px;
      text-align:center;opacity:0;transition:opacity .5s ease;
    }
    .stats-container{
      background:rgba(20,20,40,0.7);border-radius:20px;padding:20px;
      width:90%;max-width:400px;margin-bottom:25px;border:1px solid #333;
    }
    .stat-row{display:flex;justify-content:space-between;padding:12px 0;
      border-bottom:1px solid #222;font-size:18px;}
    .stat-row:last-child{border-bottom:none;}
    .stat-label{color:#aaa;}
    .stat-value{font-weight:bold;color:#00f3ff;}
    .stat-value.shards{color:#f300ff;}
    .menu-btn-container{display:flex;flex-direction:column;width:100%;max-width:400px;gap:15px;}

    /* SHOPS & UI */
    #shopScreen,#leaderboardScreen,#authScreen,#profileScreen,#dailyCheckInScreen,#referralScreen{
      position:absolute;top:0;left:0;width:100%;height:100%;
      background:linear-gradient(135deg,#1a0033,#000);
      display:none;flex-direction:column;align-items:center;justify-content:flex-start;
      z-index:100;padding:30px 20px 20px;overflow-y:auto;pointer-events:auto;
    }
    #shopScreen h1,#leaderboardScreen h1,#authScreen h1,#profileScreen h1,
    #dailyCheckInScreen h1,#referralScreen h1{
      font-size:36px;margin-bottom:25px;color:#f300ff;text-align:center;
    }
    .shop-header,.leaderboard-header{
      display:flex;justify-content:space-between;width:100%;max-width:400px;
      margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid #333;
    }
    .total-shards{font-size:24px;background:linear-gradient(to right,#f300ff,#7b00ff);
      -webkit-background-clip:text;background-clip:text;color:transparent;
      text-shadow:0 0 10px rgba(243,0,255,0.3);}
    .upgrade-card{
      background:rgba(30,10,50,0.7);border-radius:20px;width:100%;max-width:400px;
      padding:20px;margin-bottom:20px;border:1px solid #440088;
      transition:all .3s ease;
    }
    .upgrade-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;}
    .upgrade-title{font-size:20px;font-weight:bold;color:#d8a0ff;}
    .upgrade-cost{background:rgba(123,0,255,0.2);color:#f300ff;padding:5px 15px;
      border-radius:20px;font-weight:bold;border:1px solid #f300ff;}
    .upgrade-desc{color:#bbb;line-height:1.5;margin-bottom:15px;font-size:16px;}
    .upgrade-level{display:flex;align-items:center;justify-content:space-between;
      color:#aaa;font-size:14px;margin-bottom:15px;}
    .buy-btn{
      background:linear-gradient(to right,#7b00ff,#f300ff);border:none;border-radius:50px;
      color:#fff;font-size:18px;font-weight:bold;padding:12px 25px;width:100%;cursor:pointer;
      transition:all .3s ease;box-shadow:0 5px 15px rgba(243,0,255,0.4);letter-spacing:1px;
      pointer-events:auto;touch-action:manipulation;
    }
    .buy-btn:active{transform:scale(.95);box-shadow:0 3px 10px rgba(243,0,255,0.6);}
    .buy-btn:disabled{background:#555;box-shadow:none;cursor:not-allowed;}

    /* AUTH */
    #authScreen{background:linear-gradient(135deg,#0f0c4d,#000);z-index:200;}
    .auth-container{
      width:100%;max-width:400px;background:rgba(20,20,40,0.7);
      border-radius:20px;padding:25px;margin-bottom:20px;
    }
    .auth-input{
      width:100%;padding:12px 15px;margin-bottom:15px;border-radius:10px;
      border:1px solid #333;background:rgba(10,10,20,0.7);color:#fff;font-size:16px;
      outline:none;
    }
    .auth-input:focus{border-color:#00a2ff;box-shadow:0 0 10px rgba(0,162,255,0.4);}
    .auth-btn{
      width:100%;padding:12px 15px;margin-bottom:15px;border-radius:50px;
      border:none;background:linear-gradient(to right,#0047ff,#00a2ff);color:#fff;
      font-size:16px;font-weight:bold;cursor:pointer;transition:all .3s ease;
    }
    .auth-btn:active{transform:scale(.95);}
    .auth-divider{
      display:flex;align-items:center;margin:20px 0;color:#aaa;
    }
    .auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:#333;}
    .auth-divider::before{margin-right:10px;}
    .auth-divider::after{margin-left:10px;}
    .social-btn{
      width:100%;padding:12px 15px;margin-bottom:15px;border-radius:50px;
      border:1px solid #333;background:rgba(10,10,20,0.7);color:#fff;font-size:16px;
      font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;
      transition:all .3s ease;
    }
    .social-btn img{width:24px;height:24px;margin-right:10px;}
    .social-btn.google{background:#fff;color:#333;}
    .auth-switch{margin-top:20px;color:#aaa;}
    .auth-switch-btn{
      color:#00a2ff;background:none;border:none;font-size:16px;cursor:pointer;
      text-decoration:underline;
    }
    .auth-error{color:#ff4d4d;margin-bottom:15px;font-size:14px;display:none;}

    /* PROFILE */
    .user-profile{
      display:flex;align-items:center;justify-content:space-between;
      width:100%;max-width:400px;padding:15px;background:rgba(20,20,40,0.7);
      border-radius:15px;margin-bottom:20px;
    }
    .user-info{display:flex;align-items:center;}
    .user-avatar{
      width:50px;height:50px;border-radius:50%;background:#333;
      display:flex;align-items:center;justify-content:center;margin-right:15px;
      font-size:24px;color:#fff;
    }
    .user-name{font-size:18px;font-weight:bold;}
    .user-email{font-size:14px;color:#aaa;max-width:200px;overflow:hidden;text-overflow:ellipsis;}
    .logout-btn{
      background:rgba(255,77,77,0.2);color:#ff4d4d;border:1px solid #ff4d4d;
      padding:5px 15px;border-radius:20px;font-size:14px;cursor:pointer;
    }
    .profile-container{
      width:100%;max-width:400px;background:rgba(20,20,40,0.7);
      border-radius:20px;padding:20px;margin-bottom:20px;
    }
    .profile-section{margin-bottom:20px;border-bottom:1px solid #333;padding-bottom:20px;}
    .profile-section:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0;}
    .profile-title{font-size:18px;font-weight:bold;color:#d8a0ff;margin-bottom:15px;}
    .profile-field{margin-bottom:15px;}
    .profile-field-label{font-size:14px;color:#aaa;margin-bottom:5px;}
    .profile-input{
      width:100%;padding:12px 15px;border-radius:10px;border:1px solid #333;
      background:rgba(10,10,20,0.7);color:#fff;font-size:16px;outline:none;
    }
    .profile-input:focus{border-color:#00a2ff;box-shadow:0 0 10px rgba(0,162,255,0.4);}
    .save-profile-btn{
      background:linear-gradient(to right,#0047ff,#00a2ff);border:none;
      border-radius:50px;color:#fff;font-size:16px;font-weight:bold;padding:10px 20px;
      width:100%;cursor:pointer;transition:all .3s ease;margin-top:10px;
    }
    .profile-error,.profile-success{margin-top:10px;font-size:14px;text-align:center;display:none;}
    .profile-error{color:#ff4d4d;}
    .profile-success{color:#00ff7f;}

    /* LEADERBOARD */
    .leaderboard-list{width:100%;max-width:400px;}
    .leaderboard-item{display:flex;align-items:center;justify-content:space-between;
      padding:15px;background:rgba(20,20,40,0.7);border-radius:15px;margin-bottom:10px;}
    .leaderboard-rank{
      width:30px;height:30px;border-radius:50%;background:linear-gradient(to right,#0047ff,#00a2ff);
      display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:bold;
    }
    .leaderboard-rank.top-1{background:linear-gradient(to right,#ffd700,#ffaa00);color:#000;}
    .leaderboard-rank.top-2{background:linear-gradient(to right,#c0c0c0,#e0e0e0);color:#000;}
    .leaderboard-rank.top-3{background:linear-gradient(to right,#cd7f32,#e9967a);color:#000;}
    .leaderboard-player{flex:1;margin-left:15px;text-align:left;}
    .leaderboard-name{font-size:16px;font-weight:bold;}
    .leaderboard-score{font-size:14px;color:#00f3ff;}
    .leaderboard-score.shards{color:#f300ff;}
    .leaderboard-tabs{display:flex;width:100%;max-width:400px;margin-bottom:20px;}
    .leaderboard-tab{flex:1;padding:10px;text-align:center;background:rgba(20,20,40,0.7);cursor:pointer;}
    .leaderboard-tab:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px;}
    .leaderboard-tab:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px;}
    .leaderboard-tab.active{background:linear-gradient(to right,#0047ff,#00a2ff);font-weight:bold;}

    /* DAILY CHECK‑IN */
    .calendar-container{
      width:100%;max-width:400px;background:rgba(20,20,40,0.7);
      border-radius:20px;padding:20px;margin-bottom:20px;
    }
    .calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;}
    .calendar-title{font-size:20px;font-weight:bold;}
    .calendar-streak{
      background:rgba(123,0,255,0.2);color:#f300ff;padding:5px 15px;
      border-radius:20px;font-weight:bold;border:1px solid #f300ff;
    }
    .calendar-days{display:flex;justify-content:space-between;margin-bottom:20px;}
    .calendar-day{
      width:48px;height:60px;background:rgba(10,10,20,0.7);border-radius:10px;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      position:relative;
    }
    .calendar-day.active{background:rgba(0,243,255,0.2);border:1px solid #00f3ff;}
    .calendar-day.completed{background:rgba(0,243,255,0.4);border:1px solid #00f3ff;}
    .calendar-day.current{
      background:linear-gradient(to bottom,rgba(123,0,255,0.4),rgba(243,0,255,0.4));
      border:1px solid #f300ff;
    }
    .day-number{font-size:18px;font-weight:bold;}
    .day-reward{font-size:12px;color:#aaa;}
    .check-icon{
      position:absolute;top:-5px;right:-5px;width:20px;height:20px;
      border-radius:50%;background:#00f3ff;color:#000;font-size:12px;
      display:flex;align-items:center;justify-content:center;
    }
    .claim-btn{
      background:linear-gradient(to right,#0047ff,#00a2ff);border:none;
      border-radius:50px;color:#fff;font-size:18px;font-weight:bold;
      padding:12px 25px;width:100%;cursor:pointer;transition:all .3s ease;
    }
    .claim-btn:disabled{background:#555;cursor:not-allowed;}

    /* REFERRAL */
    .referral-container{
      width:100%;max-width:400px;background:rgba(20,20,40,0.7);
      border-radius:20px;padding:20px;margin-bottom:20px;
    }
    .referral-header{margin-bottom:15px;}
    .referral-title{font-size:20px;font-weight:bold;color:#d8a0ff;margin-bottom:5px;}
    .referral-desc{color:#aaa;font-size:14px;line-height:1.5;}
    .referral-code-container{
      background:rgba(10,10,20,0.7);border-radius:10px;padding:15px;
      margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;
    }
    .referral-code{font-size:24px;font-weight:bold;color:#00f3ff;letter-spacing:2px;}
    .copy-btn{
      background:rgba(0,243,255,0.2);color:#00f3ff;border:1px solid #00f3ff;
      padding:5px 15px;border-radius:20px;font-size:14px;cursor:pointer;
    }
    .friend-referral{margin-top:20px;}
    .friend-referral-title{font-size:18px;font-weight:bold;color:#d8a0ff;margin-bottom:10px;}
    .friend-code-input{
      width:100%;padding:12px 15px;margin-bottom:15px;border-radius:10px;
      border:1px solid #333;background:rgba(10,10,20,0.7);color:#fff;font-size:16px;outline:none;
    }
    .submit-code-btn{
      background:linear-gradient(to right,#7b00ff,#f300ff);border:none;
      border-radius:50px;color:#fff;font-size:16px;font-weight:bold;
      padding:10px 20px;width:100%;cursor:pointer;transition:all .3s ease;
    }
    .referral-status{margin-top:15px;color:#aaa;font-size:14px;text-align:center;}

    .spinner{
      width:40px;height:40px;border-radius:50%;
      border:4px solid rgba(255,255,255,0.1);border-top-color:#00f3ff;
      animation:spin 1s infinite linear;margin:20px auto;
    }
    @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

    @media (max-height:650px){
      .menu-btn{padding:12px 30px;font-size:18px;}
      #menuScreen h1{font-size:36px;}
      .score-display,.shard-count{font-size:20px;top:15px;}
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <div class="time-bend-effect" id="timeBendEffect"></div>
    <div id="uiContainer">
      <div class="score-display">Score: <span id="scoreValue">0</span></div>
      <div class="shard-count">✦ <span id="shardValue">0</span></div>
      <div class="time-bend-ui" id="timeBendBtn">
        <div class="time-bend-icon">⏳</div>
        <div class="time-bend-cooldown" id="timeBendCooldown"></div>
        <div class="time-bend-counter" id="timeBendCounter">1</div>
      </div>
    </div>

    <!-- MENU -->
    <div id="menuScreen">
      <h1>SHATTERLOOP</h1>
      <p>Guide the Aether Drifter through fractal dimensions. Bend time, collect shards, and master the loop. Choose your path wisely...</p>
      <button class="menu-btn" id="safeModeBtn">SAFE PATH</button>
      <button class="menu-btn fracture" id="fractureModeBtn">FRACTURE PATH</button>
      <button class="menu-btn" id="shopBtn">UPGRADES & RELICS</button>
      <button class="menu-btn" id="leaderboardBtn">LEADERBOARD</button>
      <button class="menu-btn" id="dailyCheckInBtn">DAILY CHECK-IN</button>
      <button class="menu-btn" id="referralBtn">REFERRALS</button>
      <div class="user-badge" id="userBadge">👤</div>
    </div>

    <!-- GAME OVER -->
    <div id="gameOverScreen">
      <h2>Run Over ❌</h2>
      <div class="stats-container">
        <div class="stat-row"><span class="stat-label">Time Survived:</span><span class="stat-value" id="timeSurvived">0:00</span></div>
        <div class="stat-row"><span class="stat-label">Final Score:</span><span class="stat-value" id="finalScore">0</span></div>
        <div class="stat-row"><span class="stat-label">Shards Collected:</span><span class="stat-value shards" id="shardsCollected">0</span></div>
      </div>
      <div class="menu-btn-container">
        <button class="menu-btn" id="retryBtn">Retry ⟳</button>
        <button class="menu-btn fracture" id="fractureRetryBtn">Take Fracture Path</button>
        <button class="menu-btn" id="menuBtn">Main Menu</button>
      </div>
    </div>

    <!-- SHOP -->
    <div id="shopScreen">
      <h1>UPGRADE STATION</h1>
      <div class="shop-header">
        <div>Total Shards:</div>
        <div class="total-shards">✦ <span id="totalShards">0</span></div>
      </div>

      <div class="upgrade-card">
        <div class="upgrade-header">
          <div class="upgrade-title">Time Bend Capacity</div>
          <div class="upgrade-cost" id="timeBendCost">50 ✦</div>
        </div>
        <div class="upgrade-desc">Increase the number of time bends you can use per run.</div>
        <div class="upgrade-level"><span>Current Uses: <span id="timeBendLevel">1</span></span></div>
        <button class="buy-btn" id="upgradeTimeBendBtn">Upgrade</button>
      </div>

      <div class="upgrade-card">
        <div class="upgrade-header">
          <div class="upgrade-title">Shard Magnet</div>
          <div class="upgrade-cost" id="magnetCost">30 ✦</div>
        </div>
        <div class="upgrade-desc">Increases collection radius for shards.</div>
        <div class="upgrade-level"><span>Current Level: <span id="magnetLevel">0</span></span></div>
        <button class="buy-btn" id="upgradeMagnetBtn">Upgrade</button>
      </div>

      <div class="upgrade-card">
        <div class="upgrade-header">
          <div class="upgrade-title">Phantom Relic</div>
          <div class="upgrade-cost" id="phantomCost">120 ✦</div>
        </div>
        <div class="upgrade-desc">Grants ability to phase through obstacles. Each level adds 1 phase‑through per run.</div>
        <div class="upgrade-level"><span>Current Level: <span id="phantomLevel">0</span></span></div>
        <button class="buy-btn" id="buyRelicBtn">Upgrade</button>
      </div>

      <button class="menu-btn" id="backToMenuBtn" style="margin-top:20px;">Back to Main Menu</button>
    </div>

    <!-- LEADERBOARD -->
    <div id="leaderboardScreen">
      <h1>LEADERBOARD</h1>
      <div class="leaderboard-tabs">
        <div class="leaderboard-tab active" data-type="score">Highest Score</div>
        <div class="leaderboard-tab" data-type="shards">Most Shards</div>
        <div class="leaderboard-tab" data-type="referrals">Top Referrers</div>
      </div>
      <div class="leaderboard-list" id="leaderboardList"><div class="spinner"></div></div>
      <button class="menu-btn" id="leaderboardBackBtn" style="margin-top:20px;">Back to Main Menu</button>
    </div>

    <!-- DAILY CHECK‑IN -->
    <div id="dailyCheckInScreen">
      <h1>DAILY CHECK-IN</h1>
      <div class="calendar-container">
        <div class="calendar-header">
          <div class="calendar-title">Weekly Rewards</div>
          <div class="calendar-streak">Streak: <span id="streakCount">0</span> days</div>
        </div>
        <div class="calendar-days" id="calendarDays"></div>
        <button class="claim-btn" id="claimDailyBtn">Claim Today's Reward</button>
      </div>
      <button class="menu-btn" id="dailyCheckInBackBtn">Back to Main Menu</button>
    </div>

    <!-- REFERRAL -->
    <div id="referralScreen">
      <h1>REFERRALS</h1>
      <div class="referral-container">
        <div class="referral-header">
          <div class="referral-title">Your Referral Code</div>
          <div class="referral-desc">Share this code with friends. You'll both get 50 shards when they use it!</div>
        </div>
        <div class="referral-code-container">
          <div class="referral-code" id="myReferralCode">LOADING...</div>
          <button class="copy-btn" id="copyCodeBtn">Copy</button>
        </div>
        <div class="referral-stats">
          <div>Friends Referred: <span id="friendsReferred">0</span></div>
          <div>Shards Earned: <span id="referralShards">0</span></div>
        </div>

        <div class="friend-referral" id="friendReferralSection">
          <div class="friend-referral-title">Enter Friend's Code</div>
          <input type="text" class="friend-code-input" id="friendCodeInput" placeholder="Enter code" maxlength="8">
          <button class="submit-code-btn" id="submitCodeBtn">Submit</button>
          <div class="referral-status" id="referralStatus"></div>
        </div>
      </div>
      <button class="menu-btn" id="referralBackBtn">Back to Main Menu</button>
    </div>

    <!-- PROFILE -->
    <div id="profileScreen">
      <h1>PROFILE</h1>
      <div class="user-profile">
        <div class="user-info">
          <div class="user-avatar" id="profileAvatar">👤</div>
          <div>
            <div class="user-name" id="profileName">User Name</div>
            <div class="user-email" id="profileEmail">user@example.com</div>
          </div>
        </div>
        <button class="logout-btn" id="profileLogoutBtn">Log Out</button>
      </div>

      <div class="profile-container">
        <div class="profile-section">
          <div class="profile-title">Change Username</div>
          <div class="profile-field">
            <div class="profile-field-label">Username</div>
            <input type="text" class="profile-input" id="usernameInput" placeholder="Enter new username">
          </div>
          <button class="save-profile-btn" id="saveUsernameBtn">Save Username</button>
          <div class="profile-error" id="usernameError"></div>
          <div class="profile-success" id="usernameSuccess"></div>
        </div>

        <div class="profile-section">
          <div class="profile-title">Change Password</div>
          <div class="profile-field">
            <div class="profile-field-label">Current Password</div>
            <input type="password" class="profile-input" id="currentPasswordInput" placeholder="Enter current password">
          </div>
          <div class="profile-field">
            <div class="profile-field-label">New Password</div>
            <input type="password" class="profile-input" id="newPasswordInput" placeholder="Enter new password">
          </div>
          <div class="profile-field">
            <div class="profile-field-label">Confirm New Password</div>
            <input type="password" class="profile-input" id="confirmNewPasswordInput" placeholder="Confirm new password">
          </div>
          <button class="save-profile-btn" id="savePasswordBtn">Update Password</button>
          <div class="profile-error" id="passwordError"></div>
          <div class="profile-success" id="passwordSuccess"></div>
        </div>
      </div>
      <button class="menu-btn" id="profileBackBtn">Back to Main Menu</button>
    </div>

    <!-- AUTH -->
    <div id="authScreen">
      <h1 id="authTitle">Sign In</h1>

      <div class="auth-container" id="signInContainer">
        <div class="auth-error" id="authError"></div>
        <input type="email" class="auth-input" id="emailInput" placeholder="Email" autocomplete="email">
        <input type="password" class="auth-input" id="passwordInput" placeholder="Password" autocomplete="current-password">
        <button class="auth-btn" id="signInBtn">Sign In</button>

        <div class="auth-divider">or</div>

        <button class="social-btn google" id="googleSignInBtn">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
          Sign in with Google
        </button>

        <div class="auth-switch">
          Don't have an account? <button class="auth-switch-btn" id="switchToSignUpBtn">Sign Up</button>
        </div>
      </div>

      <div class="auth-container" id="signUpContainer" style="display:none;">
        <div class="auth-error" id="signUpError"></div>
        <input type="text" class="auth-input" id="usernameSignUpInput" placeholder="Username (for leaderboard)" autocomplete="username">
        <input type="email" class="auth-input" id="signUpEmailInput" placeholder="Email" autocomplete="email">
        <input type="password" class="auth-input" id="signUpPasswordInput" placeholder="Password" autocomplete="new-password">
        <input type="password" class="auth-input" id="confirmPasswordInput" placeholder="Confirm Password" autocomplete="new-password">
        <button class="auth-btn" id="signUpBtn">Sign Up</button>

        <div class="auth-switch">
          Already have an account? <button class="auth-switch-btn" id="switchToSignInBtn">Sign In</button>
        </div>
      </div>
    </div>

    <!-- RELIC POPUP -->
    <div class="relic-popup" id="relicPopup">
      <div class="relic-icon">💠</div>
      <div class="relic-title">PHANTOM PHASE</div>
      <div class="relic-desc">You've upgraded the Phantom Phase relic! Tap the icon during gameplay to phase through obstacles.</div>
      <button class="relic-btn" id="relicCloseBtn">Continue</button>
    </div>
  </div>

  <script>
    // ----------------------------------------------------------------------
    // Firebase configuration – replace with your own project values
    // ----------------------------------------------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyAqHDZHG626E_U9swnvAbobNxbznWYjByo",
      authDomain: "shatterloop-a7640.firebaseapp.com",
      projectId: "shatterloop-a7640",
      storageBucket: "shatterloop-a7640.firebasestorage.app",
      messagingSenderId: "568996461864",
      appId: "1:568996461864:web:92fc542d589667491f241d",
      measurementId: "G-HRZ1HHS754"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    let currentUser = null;

    // ----------------------------------------------------------------------
    // Game constants
    // ----------------------------------------------------------------------
    const GAME_WIDTH  = 400;
    const GAME_HEIGHT = 800;
    const PLAYER_SIZE = 30;

    // ----------------------------------------------------------------------
    // Global game state
    // ----------------------------------------------------------------------
    let gameState = {
      score: 0,
      totalShards: 0,
      mode: 'safe',
      player: { x: GAME_WIDTH/2, y: GAME_HEIGHT-100, targetX: GAME_WIDTH/2,
                size: PLAYER_SIZE, isAlive:true, trail:[] },
      obstacles: [],
      shardsCollectible: [],
      particles: [],
      timeBend: { maxUses:1, currentUses:1, cooldown:0,
                 maxCooldown:5000, duration:2000, active:false },
      upgrades: { timeBendLevel:1, shardMagnetLevel:0, phantomPhaseLevel:0 },
      relics: { phantomPhase:false, phantomPhaseUsed:0 },
      gameActive: false,
      currentRunShards: 0,
      path: { lastX: GAME_WIDTH/2, nextY: GAME_HEIGHT-200 },
      highScore: 0,
      highScoreDisplay: '0.000',
      totalShardsCollected: 0,
      speedMultiplier: 1.0,
      gameStartTime: 0,
      dailyCheckIn: { lastCheckIn:null, streak:0, maxStreak:0 },
      referral: { code:'', friendCode:'', referred:0, shardsEarned:0 }
    };

    // ----------------------------------------------------------------------
    // DOM references
    // ----------------------------------------------------------------------
    const canvas               = document.getElementById('gameCanvas');
    const ctx                  = canvas.getContext('2d');
    const scoreValue           = document.getElementById('scoreValue');
    const shardValue           = document.getElementById('shardValue');
    const timeBendBtn          = document.getElementById('timeBendBtn');
    const timeBendCounter      = document.getElementById('timeBendCounter');
    const timeBendCooldown     = document.getElementById('timeBendCooldown');
    const timeBendEffect       = document.getElementById('timeBendEffect');
    const gameOverScreen       = document.getElementById('gameOverScreen');
    const finalScore           = document.getElementById('finalScore');
    const shardsCollected      = document.getElementById('shardsCollected');
    const timeSurvived         = document.getElementById('timeSurvived');
    const totalShardsEl        = document.getElementById('totalShards');

    const menuScreen           = document.getElementById('menuScreen');
    const safeModeBtn          = document.getElementById('safeModeBtn');
    const fractureModeBtn      = document.getElementById('fractureModeBtn');
    const shopBtn              = document.getElementById('shopBtn');
    const leaderboardBtn       = document.getElementById('leaderboardBtn');
    const dailyCheckInBtn      = document.getElementById('dailyCheckInBtn');
    const referralBtn          = document.getElementById('referralBtn');
    const userBadge            = document.getElementById('userBadge');
    const retryBtn             = document.getElementById('retryBtn');
    const fractureRetryBtn     = document.getElementById('fractureRetryBtn');
    const menuBtn              = document.getElementById('menuBtn');

    const shopScreen           = document.getElementById('shopScreen');
    const backToMenuBtn        = document.getElementById('backToMenuBtn');

    const leaderboardScreen    = document.getElementById('leaderboardScreen');
    const leaderboardList      = document.getElementById('leaderboardList');
    const leaderboardTabs      = document.querySelectorAll('.leaderboard-tab');
    const leaderboardBackBtn   = document.getElementById('leaderboardBackBtn');

    const dailyCheckInScreen   = document.getElementById('dailyCheckInScreen');
    const calendarDays         = document.getElementById('calendarDays');
    const streakCount          = document.getElementById('streakCount');
    const claimDailyBtn        = document.getElementById('claimDailyBtn');
    const dailyCheckInBackBtn  = document.getElementById('dailyCheckInBackBtn');

    const referralScreen       = document.getElementById('referralScreen');
    const myReferralCode       = document.getElementById('myReferralCode');
    const copyCodeBtn          = document.getElementById('copyCodeBtn');
    const friendsReferred      = document.getElementById('friendsReferred');
    const referralShards       = document.getElementById('referralShards');
    const friendReferralSection= document.getElementById('friendReferralSection');
    let   friendCodeInput      = document.getElementById('friendCodeInput');
    const submitCodeBtn        = document.getElementById('submitCodeBtn');
    const referralStatus       = document.getElementById('referralStatus');
    const referralBackBtn      = document.getElementById('referralBackBtn');

    const profileScreen        = document.getElementById('profileScreen');
    const profileAvatar        = document.getElementById('profileAvatar');
    const profileName          = document.getElementById('profileName');
    const profileEmail         = document.getElementById('profileEmail');
    const usernameInput        = document.getElementById('usernameInput');
    const saveUsernameBtn      = document.getElementById('saveUsernameBtn');
    const usernameError        = document.getElementById('usernameError');
    const usernameSuccess      = document.getElementById('usernameSuccess');
    const currentPasswordInput = document.getElementById('currentPasswordInput');
    const newPasswordInput     = document.getElementById('newPasswordInput');
    const confirmNewPasswordInput = document.getElementById('confirmNewPasswordInput');
    const savePasswordBtn      = document.getElementById('savePasswordBtn');
    const passwordError        = document.getElementById('passwordError');
    const passwordSuccess      = document.getElementById('passwordSuccess');
    const profileLogoutBtn     = document.getElementById('profileLogoutBtn');
    const profileBackBtn       = document.getElementById('profileBackBtn');

    const authScreen           = document.getElementById('authScreen');
    const authTitle            = document.getElementById('authTitle');
    const signInContainer      = document.getElementById('signInContainer');
    const signUpContainer      = document.getElementById('signUpContainer');

    const emailInput           = document.getElementById('emailInput');
    const passwordInput        = document.getElementById('passwordInput');
    const signInBtn            = document.getElementById('signInBtn');
    const googleSignInBtn      = document.getElementById('googleSignInBtn');
    const switchToSignUpBtn    = document.getElementById('switchToSignUpBtn');

    const usernameSignUpInput  = document.getElementById('usernameSignUpInput');
    const signUpEmailInput     = document.getElementById('signUpEmailInput');
    const signUpPasswordInput  = document.getElementById('signUpPasswordInput');
    const confirmPasswordInput = document.getElementById('confirmPasswordInput');
    const signUpBtn            = document.getElementById('signUpBtn');
    const switchToSignInBtn    = document.getElementById('switchToSignInBtn');

    const authError            = document.getElementById('authError');
    const signUpError          = document.getElementById('signUpError');

    const timeBendCostEl       = document.getElementById('timeBendCost');
    const timeBendLevelEl      = document.getElementById('timeBendLevel');
    const magnetCostEl         = document.getElementById('magnetCost');
    const magnetLevelEl        = document.getElementById('magnetLevel');
    const phantomCostEl        = document.getElementById('phantomCost');
    const phantomLevelEl       = document.getElementById('phantomLevel');
    const upgradeTimeBendBtn   = document.getElementById('upgradeTimeBendBtn');
    const upgradeMagnetBtn     = document.getElementById('upgradeMagnetBtn');
    const buyRelicBtn          = document.getElementById('buyRelicBtn');

    // ----------------------------------------------------------------------
    // INITIALISATION
    // ----------------------------------------------------------------------
    function initGame() {
      canvas.width  = GAME_WIDTH;
      canvas.height = GAME_HEIGHT;

      setupEventListeners();
      setupAuthListeners();
      gameLoop();

      showAuthScreen();

      // React to auth changes
      auth.onAuthStateChanged(user => {
        if (user) {
          currentUser = user;
          loadUserData();
          updateUserProfile();
          if (authScreen.style.display === 'flex') showMenu();
        } else {
          currentUser = null;
          if (authScreen.style.display !== 'flex') showAuthScreen();
        }
        updateAuthUI();
      });
    }

    // ----------------------------------------------------------------------
    // AUTH LISTENERS
    // ----------------------------------------------------------------------
    function setupAuthListeners() {
      // ----- Sign In -------------------------------------------------------
      signInBtn.addEventListener('click', () => {
        const email = emailInput.value;
        const password = passwordInput.value;
        if (!email || !password) { showAuthError('Please enter both email and password'); return; }

        auth.signInWithEmailAndPassword(email, password)
          .then(() => {
            authScreen.style.display = 'none';
            menuScreen.style.display = 'flex';
          })
          .catch(err => showAuthError(err.message));
      });

      // ----- Google Sign‑In -------------------------------------------------
      googleSignInBtn.addEventListener('click', () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider)
          .then(result => {
            const isNew = result.additionalUserInfo.isNewUser;
            if (isNew) {
              const username = result.user.displayName
                               ? result.user.displayName.replace(/\s+/g,'').toLowerCase() + Math.floor(Math.random()*1000)
                               : (result.user.email ? result.user.email.split('@')[0] : 'user') + Math.floor(Math.random()*1000);
              const referralCode = generateReferralCode();
              createNewUserDocument(result.user.uid, {
                displayName: result.user.displayName || 'Anonymous',
                email: result.user.email,
                username,
                referralCode,
                totalShards: 0,
                highScore: 0
              });
            }
            authScreen.style.display = 'none';
            menuScreen.style.display = 'flex';
          })
          .catch(err => showAuthError(err.message));
      });

      // ----- Sign Up --------------------------------------------------------
      signUpBtn.addEventListener('click', () => {
        const username = usernameSignUpInput.value.trim();
        const email    = signUpEmailInput.value.trim();
        const password = signUpPasswordInput.value;
        const confirm  = confirmPasswordInput.value;

        if (!username || !email || !password || !confirm) {
          showSignUpError('Please fill in all fields');
          return;
        }
        if (password !== confirm) {
          showSignUpError('Passwords do not match');
          return;
        }

        checkUsernameAvailability(username)
          .then(isFree => {
            if (!isFree) { showSignUpError('Username is already taken'); return; }
            return auth.createUserWithEmailAndPassword(email, password);
          })
          .then(cred => {
            const referralCode = generateReferralCode();
            return createNewUserDocument(cred.user.uid, {
              displayName: username,
              email,
              username,
              referralCode,
              totalShards: 0,
              highScore: 0
            }).then(() => cred.user.updateProfile({ displayName: username }));
          })
          .then(() => {
            authScreen.style.display = 'none';
            menuScreen.style.display = 'flex';
          })
          .catch(err => showSignUpError(err.message));
      });

      // ----- Logout ---------------------------------------------------------
      profileLogoutBtn.addEventListener('click', () => {
        auth.signOut()
          .then(() => {
            profileScreen.style.display = 'none';
            showAuthScreen();
          })
          .catch(err => console.error('Logout error', err));
      });

      // ----- Switch between sign‑in / sign‑up ------------------------------
      switchToSignUpBtn.addEventListener('click', () => {
        signInContainer.style.display = 'none';
        signUpContainer.style.display = 'block';
        authTitle.textContent = 'Sign Up';
      });
      switchToSignInBtn.addEventListener('click', () => {
        signUpContainer.style.display = 'none';
        signInContainer.style.display = 'block';
        authTitle.textContent = 'Sign In';
      });

      // ----- Profile & Referral UI -----------------------------------------
      userBadge.addEventListener('click', showProfileScreen);
      saveUsernameBtn.addEventListener('click', updateUsername);
      savePasswordBtn.addEventListener('click', updatePassword);
      profileBackBtn.addEventListener('click', showMenu);

      copyCodeBtn.addEventListener('click', copyReferralCode);
      submitCodeBtn.addEventListener('click', submitReferralCode);
      referralBackBtn.addEventListener('click', showMenu);
    }

    // ----------------------------------------------------------------------
    // USER / DATABASE HELPERS
    // ----------------------------------------------------------------------
    function createNewUserDocument(uid, data) {
      return db.collection('users').doc(uid).set({
        displayName: data.displayName,
        email: data.email,
        username: data.username,
        referralCode: data.referralCode,
        totalShards: 0,
        highScore: 0,
        upgrades: {
          timeBendLevel: 1,
          shardMagnetLevel: 0,
          phantomPhaseLevel: 0
        },
        dailyCheckIn: { lastCheckIn: null, streak: 0, maxStreak: 0 },
        referral: {
          code: data.referralCode,
          friendCode: '',
          referred: 0,
          shardsEarned: 0
        },
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    function checkUsernameAvailability(username) {
      return db.collection('users')
               .where('username', '==', username)
               .get()
               .then(snap => snap.empty);
    }

    function generateReferralCode() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let code = '';
      for (let i = 0; i < 8; i++) code += chars.charAt(Math.floor(Math.random()*chars.length));
      return code;
    }

    // ----------------------------------------------------------------------
    // USER PROFILE UI
    // ----------------------------------------------------------------------
    function updateUserProfile() {
      if (!currentUser) return;
      profileName.textContent = currentUser.displayName || 'Anonymous';
      profileEmail.textContent = currentUser.email || '';
      if (currentUser.photoURL) {
        profileAvatar.innerHTML = `<img src="${currentUser.photoURL}" alt="${currentUser.displayName}"
                                   style="width:100%;height:100%;border-radius:50%;">`;
      } else {
        profileAvatar.textContent = currentUser.displayName ? currentUser.displayName.charAt(0).toUpperCase() : '👤';
      }
      usernameInput.placeholder = currentUser.displayName || 'Enter new username';
    }

    // ----------------------------------------------------------------------
    // REFERRAL UI & LOGIC
    // ----------------------------------------------------------------------
    function updateReferralUI() {
      if (!currentUser) return;

      myReferralCode.textContent = gameState.referral.code || 'LOADING...';
      friendsReferred.textContent = gameState.referral.referred || '0';
      referralShards.textContent  = gameState.referral.shardsEarned || '0';

      // Re‑create the input area only if it vanished (e.g. after a successful submit)
      if (!document.getElementById('friendCodeInput')) {
        friendReferralSection.innerHTML = `
          <div class="friend-referral-title">Enter Friend's Code</div>
          <input type="text" class="friend-code-input" id="friendCodeInput" placeholder="Enter code" maxlength="8">
          <button class="submit-code-btn" id="submitCodeBtn">Submit</button>
          <div class="referral-status" id="referralStatus"></div>
        `;
        friendCodeInput = document.getElementById('friendCodeInput');
        document.getElementById('submitCodeBtn')
                .addEventListener('click', submitReferralCode);
      }
    }

    function copyReferralCode() {
      const code = myReferralCode.textContent;
      navigator.clipboard.writeText(code).then(() => {
        copyCodeBtn.textContent = 'Copied!';
        setTimeout(() => copyCodeBtn.textContent = 'Copy', 2000);
      }).catch(err => console.error('Copy failed', err));
    }

    // ------------------------------------------------------------
    // *** FIXED REFERRAL SUBMIT ***
    // ------------------------------------------------------------
    function submitReferralCode() {
      if (!currentUser) return;

      const code = friendCodeInput.value.trim().toUpperCase();
      if (!code) { updateReferralStatus('Please enter a referral code', 'error'); return; }

      db.collection('users').doc(currentUser.uid).get()
        .then(doc => {
          if (!doc.exists) throw new Error('Current user not found.');
          const data = doc.data();
          const myCode = (data.referral && data.referral.code) || data.referralCode;

          if (data.referral && data.referral.friendCode) {
            throw new Error('You have already used a referral code');
          }
          if (code === myCode) {
            throw new Error('You cannot use your own referral code');
          }

          // Try the new‑field first, then fallback to the legacy field
          const query = db.collection('users')
                         .where('referral.code', '==', code)
                         .limit(1);
          return query.get().then(snap => {
            if (!snap.empty) return snap.docs[0];
            // fallback to legacy top‑level field
            return db.collection('users')
                     .where('referralCode', '==', code)
                     .limit(1)
                     .get()
                     .then(snap2 => {
                       if (snap2.empty) throw new Error('Invalid referral code');
                       return snap2.docs[0];
                     });
          });
        })
        .then(referrerDoc => {
          // Update both users – use merge‑set for the friend‑code to satisfy rules
          const userUpdate = db.collection('users')
                               .doc(currentUser.uid)
                               .set({
                                 referral: { friendCode: code },
                                 totalShards: firebase.firestore.FieldValue.increment(50)
                               }, { merge: true });

          const referrerUpdate = referrerDoc.ref.update({
            'referral.referred': firebase.firestore.FieldValue.increment(1),
            'referral.shardsEarned': firebase.firestore.FieldValue.increment(50),
            totalShards: firebase.firestore.FieldValue.increment(50)
          });

          return Promise.all([userUpdate, referrerUpdate]);
        })
        .then(() => {
          gameState.totalShards += 50;
          updateReferralStatus('Success! You received 50 shards', 'success');
          friendReferralSection.innerHTML = `<div class="referral-status">
            You have used the referral code: ${code}
          </div>`;
          loadUserData();
        })
        .catch(err => {
          updateReferralStatus(err.message, 'error');
          console.error('Referral error:', err);
        });
    }

    function updateReferralStatus(msg, type) {
      referralStatus.textContent = msg;
      referralStatus.style.color = type === 'error' ? '#ff4d4d' : '#00ff7f';
      referralStatus.style.display = 'block';
      setTimeout(() => referralStatus.style.display = 'none', 5000);
    }

    // ----------------------------------------------------------------------
    // DAILY CHECK‑IN
    // ----------------------------------------------------------------------
    // ------------------------------------------------------------
    // *** FIXED DAILY CLAIM ***
    // ------------------------------------------------------------
    function claimDailyReward() {
      if (!currentUser) return;

      claimDailyBtn.disabled = true;
      claimDailyBtn.textContent = 'Claiming...';
      const userRef = db.collection('users').doc(currentUser.uid);

      userRef.get()
        .then(doc => {
          if (!doc.exists) throw new Error('User data not found.');

          const data = doc.data();
          const checkIn = data.dailyCheckIn || { lastCheckIn: null, streak: 0, maxStreak: 0 };
          const now = new Date();

          const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
          const lastStart = checkIn.lastCheckIn
            ? new Date(checkIn.lastCheckIn.toDate().setHours(0,0,0,0)).getTime()
            : 0;

          if (lastStart === todayStart) throw new Error('Reward already claimed for today.');

          const yesterdayStart = todayStart - 86400000; // 24 h
          const newStreak = (lastStart === yesterdayStart) ? (checkIn.streak + 1) : 1;

          const rewards = [20,20,20,30,30,50,100];
          const reward = rewards[Math.min(newStreak-1, rewards.length-1)];

          // Use set‑with‑merge so nested map writes are allowed by the rules
          return userRef.set({
            dailyCheckIn: {
              lastCheckIn: firebase.firestore.FieldValue.serverTimestamp(),
              streak: newStreak,
              maxStreak: Math.max(newStreak, checkIn.maxStreak || 0)
            },
            totalShards: firebase.firestore.FieldValue.increment(reward)
          }, { merge:true })
            .then(() => reward);
        })
        .then(reward => {
          claimDailyBtn.textContent = `Claimed ${reward} ✦`;
          claimDailyBtn.disabled = true;          // stay disabled until tomorrow
          updateDailyCheckInUI();
        })
        .catch(err => {
          claimDailyBtn.disabled = false;
          claimDailyBtn.textContent = "Claim Today's Reward";
          console.error('Daily claim error:', err);
          alert(err.message);
        });
    }

    function updateDailyCheckInUI() {
      if (!currentUser) return;
      db.collection('users').doc(currentUser.uid).get()
        .then(doc => {
          if (!doc.exists) return;
          const data = doc.data();
          const checkIn = data.dailyCheckIn || { lastCheckIn: null, streak: 0 };
          const streak = checkIn.streak || 0;
          streakCount.textContent = `${streak} days`;

          const now = new Date();
          const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
          const lastStart = checkIn.lastCheckIn
            ? new Date(checkIn.lastCheckIn.toDate().setHours(0,0,0,0)).getTime()
            : 0;
          const claimedToday = (lastStart === todayStart);

          const rewards = [20,20,20,30,30,50,100];
          calendarDays.innerHTML = '';
          for (let i = 1; i <= 7; i++) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            if (i <= streak) dayDiv.classList.add('completed');
            else if (i === streak + 1 && !claimedToday) dayDiv.classList.add('current');

            if (i <= streak) dayDiv.innerHTML = '<div class="check-icon">✓</div>';
            dayDiv.innerHTML += `<div class="day-number">Day ${i}</div>
                                 <div class="day-reward">${rewards[i-1]} ✦</div>`;
            calendarDays.appendChild(dayDiv);
          }

          if (claimedToday) {
            claimDailyBtn.disabled = true;
            const reward = rewards[Math.min(streak-1, rewards.length-1)];
            claimDailyBtn.textContent = `Claimed ${reward} ✦ Today`;
          } else {
            claimDailyBtn.disabled = false;
            claimDailyBtn.textContent = "Claim Today's Reward";
          }
        })
        .catch(err => console.error('Daily UI error', err));
    }

    // ----------------------------------------------------------------------
    // AUTH UI HELPERS
    // ----------------------------------------------------------------------
    function showAuthError(msg) {
      authError.textContent = msg;
      authError.style.display = 'block';
      setTimeout(() => authError.style.display = 'none', 5000);
    }
    function showSignUpError(msg) {
      signUpError.textContent = msg;
      signUpError.style.display = 'block';
      setTimeout(() => signUpError.style.display = 'none', 5000);
    }
    function showProfileError(el, msg) {
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }
    function showProfileSuccess(el, msg) {
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }

    function updateAuthUI() {
      if (currentUser) {
        signInContainer.style.display = 'none';
        signUpContainer.style.display = 'none';
        userBadge.innerHTML = currentUser.photoURL
          ? `<img src="${currentUser.photoURL}" alt="${currentUser.displayName}"
                 style="width:100%;height:100%;border-radius:50%;">`
          : (currentUser.displayName ? currentUser.displayName.charAt(0).toUpperCase() : '👤');
      } else {
        signInContainer.style.display = 'block';
        signUpContainer.style.display = 'none';
        userBadge.textContent = '👤';
        authTitle.textContent = 'Sign In';
      }
    }

    // ----------------------------------------------------------------------
    // USER DATA LOADING
    // ----------------------------------------------------------------------
    function loadUserData() {
      if (!currentUser) return;
      db.collection('users').doc(currentUser.uid).get()
        .then(doc => {
          if (!doc.exists) {
            const code = generateReferralCode();
            createNewUserDocument(currentUser.uid, {
              displayName: currentUser.displayName || 'Anonymous',
              email: currentUser.email,
              username: currentUser.displayName || 'Anonymous',
              referralCode: code,
              totalShards: 0,
              highScore: 0
            }).then(() => {
              gameState.referral.code = code;
            });
            return;
          }

          const data = doc.data();
          gameState.totalShards = data.totalShards || 0;
          gameState.upgrades.timeBendLevel   = data.upgrades?.timeBendLevel   || 1;
          gameState.upgrades.shardMagnetLevel= data.upgrades?.shardMagnetLevel|| 0;
          gameState.upgrades.phantomPhaseLevel = data.upgrades?.phantomPhaseLevel||0;
          gameState.relics.phantomPhase = gameState.upgrades.phantomPhaseLevel > 0;
          gameState.highScore = data.highScore || 0;
          gameState.highScoreDisplay = data.highScoreDisplay ||
                                        ((data.highScore||0)/1000).toFixed(3);
          gameState.dailyCheckIn = data.dailyCheckIn || { lastCheckIn:null, streak:0, maxStreak:0 };
          gameState.referral = data.referral || { code: generateReferralCode(),
                                                  friendCode:'', referred:0, shardsEarned:0 };

          updateShopUI();          // pulls fresh totalShards from DB
          updateUserProfile();
          updateReferralUI();
        })
        .catch(err => console.error('Load user data error', err));
    }

    // ----------------------------------------------------------------------
    // SHOP UI – fetches the latest totalShards from Firestore before rendering
    // ----------------------------------------------------------------------
    function updateShopUI() {
      if (!currentUser) {
        renderShop();   // guest mode – use local value
        return;
      }
      db.collection('users').doc(currentUser.uid).get()
        .then(doc => {
          if (doc.exists) {
            const data = doc.data();
            gameState.totalShards = data.totalShards || 0;
          }
          renderShop();
        })
        .catch(err => {
          console.error('Shop UI sync error', err);
          renderShop();
        });
    }

    function renderShop() {
      totalShardsEl.textContent = gameState.totalShards;

      // Time Bend
      const tbLevel = gameState.upgrades.timeBendLevel;
      const tbCost  = getUpgradeCost(50, tbLevel-1);
      timeBendLevelEl.textContent = tbLevel;
      timeBendCostEl.textContent   = `${tbCost} ✦`;
      upgradeTimeBendBtn.disabled = gameState.totalShards < tbCost;

      // Magnet
      const magLevel = gameState.upgrades.shardMagnetLevel;
      const magCost  = getUpgradeCost(30, magLevel);
      magnetLevelEl.textContent = magLevel;
      magnetCostEl.textContent   = `${magCost} ✦`;
      upgradeMagnetBtn.disabled = gameState.totalShards < magCost;

      // Phantom Relic
      const phLevel = gameState.upgrades.phantomPhaseLevel;
      const phCost  = getUpgradeCost(120, phLevel);
      phantomLevelEl.textContent = phLevel;
      phantomCostEl.textContent   = `${phCost} ✦`;
      buyRelicBtn.disabled = gameState.totalShards < phCost;
      buyRelicBtn.textContent = phLevel > 0 ? 'Upgrade' : 'Purchase';
    }

    // ----------------------------------------------------------------------
    // PURCHASE LOGIC
    // ----------------------------------------------------------------------
    function getUpgradeCost(base, level) {
      return Math.floor(base * Math.pow(1.5, level));
    }

    function purchaseTimeBend() {
      const level = gameState.upgrades.timeBendLevel;
      const cost  = getUpgradeCost(50, level-1);
      if (gameState.totalShards >= cost) {
        gameState.totalShards -= cost;
        gameState.upgrades.timeBendLevel++;
        updateShopUI();
        if (currentUser) saveUserData();
      }
    }

    function purchaseMagnet() {
      const level = gameState.upgrades.shardMagnetLevel;
      const cost  = getUpgradeCost(30, level);
      if (gameState.totalShards >= cost) {
        gameState.totalShards -= cost;
        gameState.upgrades.shardMagnetLevel++;
        updateShopUI();
        if (currentUser) saveUserData();
      }
    }

    function purchasePhantomRelic() {
      const level = gameState.upgrades.phantomPhaseLevel;
      const cost  = getUpgradeCost(120, level);
      if (gameState.totalShards >= cost) {
        gameState.totalShards -= cost;
        gameState.upgrades.phantomPhaseLevel++;
        gameState.relics.phantomPhase = true;
        updateShopUI();
        if (currentUser) saveUserData();
      }
    }

    // ----------------------------------------------------------------------
    // SAVE USER DATA (including the new highScoreDisplay field)
    // ----------------------------------------------------------------------
    function saveUserData() {
      if (!currentUser) return;
      db.collection('users').doc(currentUser.uid).update({
        totalShards: gameState.totalShards,
        highScore: gameState.highScore,
        highScoreDisplay: gameState.highScoreDisplay,
        upgrades: {
          timeBendLevel:   gameState.upgrades.timeBendLevel,
          shardMagnetLevel:gameState.upgrades.shardMagnetLevel,
          phantomPhaseLevel:gameState.upgrades.phantomPhaseLevel
        },
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      }).catch(err => console.error('Save data error', err));
    }

    // ----------------------------------------------------------------------
    // LEADERBOARD
    // ----------------------------------------------------------------------
    function updateLeaderboard(type='score') {
      leaderboardList.innerHTML = '<div class="spinner"></div>';
      let collection = 'users';
      let field;

      if (type === 'referrals') field = 'referral.referred';
      else field = (type === 'score') ? 'highScore' : 'totalShards';

      db.collection(collection).orderBy(field, 'desc').limit(10).get()
        .then(snapshot => {
          leaderboardList.innerHTML = '';
          if (snapshot.empty) {
            leaderboardList.innerHTML = '<p style="text-align:center;color:#aaa;">No data available</p>';
            return;
          }
          snapshot.forEach((doc, idx) => {
            const d = doc.data();
            const isMe = currentUser && doc.id === currentUser.uid;
            const name = d.username || d.displayName || 'Anonymous';
            let display;
            if (type === 'score') {
              const raw = d.highScoreDisplay || ((d.highScore||0)/1000).toFixed(3);
              display = `${raw}s`;
            } else if (type === 'shards') {
              display = '✦ ' + (d.totalShards||0);
            } else {
              display = (d.referral?.referred||0) + ' referrals';
            }
            const html = `
              <div class="leaderboard-item ${isMe ? 'current-user' : ''}">
                <div class="leaderboard-rank ${idx<3 ? 'top-'+(idx+1) : ''}">${idx+1}</div>
                <div class="leaderboard-player">
                  <div class="leaderboard-name">${name}</div>
                  <div class="leaderboard-score ${type==='shards'?'shards':''}">${display}</div>
                </div>
              </div>`;
            leaderboardList.innerHTML += html;
          });
        })
        .catch(err => {
          console.error('Leaderboard error', err);
          leaderboardList.innerHTML = '<p style="text-align:center;color:#ff4d4d;">Error loading leaderboard</p>';
        });
    }

    // ----------------------------------------------------------------------
    // GAME STATE RESET
    // ----------------------------------------------------------------------
    function resetGameState() {
      gameState.score = 0;
      gameState.currentRunShards = 0;
      gameState.gameStartTime = Date.now();
      gameState.speedMultiplier = 1.0;
      gameState.player = { x:GAME_WIDTH/2, y:GAME_HEIGHT-100, targetX:GAME_WIDTH/2,
                           size:PLAYER_SIZE, isAlive:true, trail:[] };
      gameState.obstacles = [];
      gameState.shardsCollectible = [];
      gameState.particles = [];
      gameState.timeBend.maxUses = gameState.upgrades.timeBendLevel;
      gameState.timeBend.currentUses = gameState.timeBend.maxUses;
      gameState.timeBend.cooldown = 0;
      gameState.timeBend.active = false;
      gameState.relics.phantomPhaseUsed = 0;
      gameState.path = { lastX:GAME_WIDTH/2, nextY:GAME_HEIGHT-200 };
      gameState.gameActive = true;

      scoreValue.textContent = '0';
      shardValue.textContent = '0';
      timeBendCounter.textContent = gameState.timeBend.currentUses;
      gameOverScreen.style.display = 'none';
      gameOverScreen.style.opacity = '0';
      timeBendCooldown.style.animation = 'none';
    }

    // ----------------------------------------------------------------------
    // EVENT LISTENERS (UI & Game)
    // ----------------------------------------------------------------------
    function setupEventListeners() {
      let isTouching = false;
      const handleMove = (clientX) => {
        if (!isTouching || !gameState.gameActive) return;
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const touchX = (clientX - rect.left) * scaleX;
        gameState.player.targetX = touchX;
      };
      canvas.addEventListener('touchstart', e => { e.preventDefault(); isTouching = true; handleMove(e.touches[0].clientX); });
      canvas.addEventListener('touchmove',  e => { e.preventDefault(); handleMove(e.touches[0].clientX); });
      canvas.addEventListener('touchend',   e => { e.preventDefault(); isTouching = false; });

      timeBendBtn.addEventListener('click', activateTimeBend);
      safeModeBtn.addEventListener('click', () => startGame('safe'));
      fractureModeBtn.addEventListener('click', () => startGame('fracture'));
      shopBtn.addEventListener('click', showShop);
      leaderboardBtn.addEventListener('click', showLeaderboard);
      dailyCheckInBtn.addEventListener('click', showDailyCheckIn);
      referralBtn.addEventListener('click', showReferral);
      retryBtn.addEventListener('click', () => startGame(gameState.mode));
      fractureRetryBtn.addEventListener('click', () => startGame('fracture'));
      menuBtn.addEventListener('click', showMenu);
      backToMenuBtn.addEventListener('click', showMenu);
      leaderboardBackBtn.addEventListener('click', showMenu);
      upgradeTimeBendBtn.addEventListener('click', purchaseTimeBend);
      upgradeMagnetBtn.addEventListener('click', purchaseMagnet);
      buyRelicBtn.addEventListener('click', purchasePhantomRelic);
      claimDailyBtn.addEventListener('click', claimDailyReward);
      // Leaderboard tab switching
      leaderboardTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          leaderboardTabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          updateLeaderboard(tab.dataset.type);
        });
      });
    }

    // ----------------------------------------------------------------------
    // SCREEN NAVIGATION
    // ----------------------------------------------------------------------
    function startGame(mode) {
      if (!currentUser) { showAuthScreen(); return; }
      gameState.mode = mode;
      resetGameState();
      hideAllScreens();
      menuScreen.style.display = 'none'; // ensure menu is hidden
    }

    function hideAllScreens() {
      menuScreen.style.display = 'none';
      shopScreen.style.display = 'none';
      leaderboardScreen.style.display = 'none';
      authScreen.style.display = 'none';
      profileScreen.style.display = 'none';
      dailyCheckInScreen.style.display = 'none';
      referralScreen.style.display = 'none';
      gameOverScreen.style.display = 'none';
    }

    function showMenu() {
      hideAllScreens();
      menuScreen.style.display = 'flex';
      gameState.gameActive = false;
    }

    function showShop() {
      if (!currentUser) { showAuthScreen(); return; }
      hideAllScreens();
      shopScreen.style.display = 'flex';
      updateShopUI();
    }

    function showLeaderboard() {
      if (!currentUser) { showAuthScreen(); return; }
      hideAllScreens();
      leaderboardScreen.style.display = 'flex';
      updateLeaderboard('score');
    }

    function showDailyCheckIn() {
      if (!currentUser) { showAuthScreen(); return; }
      hideAllScreens();
      dailyCheckInScreen.style.display = 'flex';
      updateDailyCheckInUI();
    }

    function showReferral() {
      if (!currentUser) { showAuthScreen(); return; }
      hideAllScreens();
      referralScreen.style.display = 'flex';
      updateReferralUI();
    }

    function showProfileScreen() {
      if (!currentUser) { showAuthScreen(); return; }
      hideAllScreens();
      profileScreen.style.display = 'flex';
      updateUserProfile();
    }

    function showAuthScreen() {
      hideAllScreens();
      authScreen.style.display = 'flex';
      updateAuthUI();
      // clear inputs
      emailInput.value = ''; passwordInput.value = '';
      usernameSignUpInput.value = ''; signUpEmailInput.value = '';
      signUpPasswordInput.value = ''; confirmPasswordInput.value = '';
      authError.style.display = 'none'; signUpError.style.display = 'none';
    }

    // ----------------------------------------------------------------------
    // USERNAME / PASSWORD UPDATE
    // ----------------------------------------------------------------------
    function updateUsername() {
      const newName = usernameInput.value.trim();
      if (!newName) { showProfileError(usernameError, 'Username cannot be empty'); return; }

      checkUsernameAvailability(newName).then(isFree => {
        if (!isFree && newName !== currentUser.displayName) {
          showProfileError(usernameError, 'Username is already taken');
          return;
        }
        db.collection('users').doc(currentUser.uid).update({
          username: newName,
          displayName: newName
        }).then(() => currentUser.updateProfile({displayName:newName}))
          .then(() => {
            updateUserProfile();
            showProfileSuccess(usernameSuccess, 'Username updated successfully');
            usernameInput.value = '';
          })
          .catch(err => showProfileError(usernameError, 'Error: '+err.message));
      }).catch(err => showProfileError(usernameError, 'Error: '+err.message));
    }

    function updatePassword() {
      const cur = currentPasswordInput.value;
      const nw  = newPasswordInput.value;
      const cnf = confirmNewPasswordInput.value;
      if (!cur || !nw || !cnf) {
        showProfileError(passwordError, 'Please fill in all password fields');
        return;
      }
      if (nw !== cnf) {
        showProfileError(passwordError, 'New passwords do not match');
        return;
      }
      const cred = firebase.auth.EmailAuthProvider.credential(currentUser.email, cur);
      currentUser.reauthenticateWithCredential(cred)
        .then(() => currentUser.updatePassword(nw))
        .then(() => {
          showProfileSuccess(passwordSuccess, 'Password updated successfully');
          currentPasswordInput.value = ''; newPasswordInput.value = ''; confirmNewPasswordInput.value = '';
        })
        .catch(err => showProfileError(passwordError, err.message));
    }

    // ----------------------------------------------------------------------
    // TIME BEND
    // ----------------------------------------------------------------------
    function activateTimeBend() {
      if (gameState.timeBend.currentUses > 0 && !gameState.timeBend.active && gameState.timeBend.cooldown <= 0) {
        gameState.timeBend.currentUses--;
        gameState.timeBend.active = true;
        gameState.timeBend.cooldown = gameState.timeBend.maxCooldown;
        timeBendCounter.textContent = gameState.timeBend.currentUses;
        timeBendEffect.style.opacity = '1';
        setTimeout(() => {
          gameState.timeBend.active = false;
          timeBendEffect.style.opacity = '0';
        }, gameState.timeBend.duration);
        timeBendCooldown.style.animation = `cooldown ${gameState.timeBend.maxCooldown/1000}s linear forwards`;
        setTimeout(() => timeBendCooldown.style.animation = '', gameState.timeBend.maxCooldown);
      }
    }

    // ----------------------------------------------------------------------
    // PARTICLES
    // ----------------------------------------------------------------------
    function createParticleExplosion(x, y, count, color) {
      for (let i = 0; i < count; i++) {
        const ang = Math.random()*Math.PI*2;
        const spd = 2 + Math.random()*4;
        gameState.particles.push({
          x, y,
          vx: Math.cos(ang)*spd,
          vy: Math.sin(ang)*spd,
          alpha:1,
          size:1+Math.random()*3,
          color
        });
      }
    }

    // ----------------------------------------------------------------------
    // GAME LOGIC
    // ----------------------------------------------------------------------
    function createObstacleLayer(baseY) {
      const isFracture = gameState.mode === 'fracture';
      const speed = isFracture ? 4 : 2;
      const obsBase = { y:baseY, height:20, speed, passed:true, isFracture };
      const gapSize = PLAYER_SIZE + (isFracture ? 60 : 75);
      const maxDrift = 120;

      let nextX = gameState.path.lastX + (Math.random()-0.5)*maxDrift;
      nextX = Math.max(gapSize/2, Math.min(GAME_WIDTH - gapSize/2, nextX));
      gameState.path.lastX = nextX;

      const gapStart = nextX - gapSize/2;
      const gapEnd   = nextX + gapSize/2;
      const density = isFracture ? 0.9 : 0.7;

      for (let i = 0; i < (isFracture ? 12 : 8); i++) {
        const fragX = Math.random()*GAME_WIDTH;
        const fragW = 20 + Math.random()*50;
        if (fragX + fragW > gapStart && fragX < gapEnd) continue;
        if (Math.random() < density) {
          gameState.obstacles.push({
            ...obsBase,
            x: fragX,
            width: fragW,
            y: baseY + (Math.random()*40-20)
          });
        }
      }
    }

    function createShard() {
      gameState.shardsCollectible.push({
        x: Math.random() * (GAME_WIDTH - 20) + 10,
        y: -15
      });
    }

    function updateGame() {
      if (!gameState.gameActive) return;

      const now = Date.now();
      const timeFactor = gameState.timeBend.active ? 0.4 : 1.0;
      const elapsedSinceStart = (now - gameState.gameStartTime) / 1000; // seconds
      gameState.speedMultiplier = 1.0 + (elapsedSinceStart * 0.001); // +0.1% per second

      // SCORE – raw ms for internal use, UI shows seconds
      gameState.score = now - gameState.gameStartTime;
      const secDisplay = (gameState.score/1000).toFixed(3);
      scoreValue.textContent = secDisplay;

      const isFracture = gameState.mode === 'fracture';
      const baseSpeed = isFracture ? 4 : 2;
      const pathSpeed = baseSpeed * gameState.speedMultiplier;

      // PLAYER movement
      gameState.player.x += (gameState.player.targetX - gameState.player.x) * 0.15;
      gameState.player.x = Math.max(PLAYER_SIZE/2, Math.min(GAME_WIDTH-PLAYER_SIZE/2, gameState.player.x));

      // TRAIL
      gameState.player.trail.push({x:gameState.player.x, y:gameState.player.y, alpha:1});
      if (gameState.player.trail.length > 20) gameState.player.trail.shift();
      gameState.player.trail.forEach(p=>p.alpha-=0.05);

      // WORLD scroll
      gameState.path.nextY -= pathSpeed * timeFactor;
      if (gameState.path.nextY <= 0) {
        createObstacleLayer(-30);
        const baseDist = isFracture ? 80 : 120;
        gameState.path.nextY = baseDist + Math.random()*40;
      }

      // SHARD spawning
      const shardRate = isFracture ? 0.03 : 0.015;
      if (Math.random() < shardRate * timeFactor) createShard();

      // UPDATE OBSTACLES
      gameState.obstacles.forEach((obs,i) => {
        obs.y += (obs.speed * gameState.speedMultiplier + elapsedSinceStart * 0.005) * timeFactor;
        if (obs.y > GAME_HEIGHT + 30) gameState.obstacles.splice(i,1);
      });

      // UPDATE SHARDS
      gameState.shardsCollectible.forEach((shard,i) => {
        shard.y += (isFracture ? 3 : 2) * gameState.speedMultiplier * timeFactor;
        const dx = shard.x - gameState.player.x;
        const dy = shard.y - gameState.player.y;
        const magnetRadius = 15 + gameState.upgrades.shardMagnetLevel * 15;
        if (Math.sqrt(dx*dx + dy*dy) < PLAYER_SIZE/2 + magnetRadius) {
          // COLLECTED – increment locally AND on Firestore
          gameState.currentRunShards++;
          shardValue.textContent = gameState.currentRunShards;
          createParticleExplosion(shard.x, shard.y, 10, '#f300ff');

          if (currentUser) {
            db.collection('users')
              .doc(currentUser.uid)
              .update({ totalShards: firebase.firestore.FieldValue.increment(1) })
              .catch(err => console.error('Shard increment error', err));
          }

          gameState.shardsCollectible.splice(i,1);
        } else if (shard.y > GAME_HEIGHT + 20) {
          gameState.shardsCollectible.splice(i,1);
        }
      });

      checkCollisions();
    }

    function checkCollisions() {
      if (!gameState.player.isAlive) return;
      const hitW = PLAYER_SIZE * 0.5;
      const hitH = PLAYER_SIZE * 0.9;
      const pL = gameState.player.x - hitW/2;
      const pR = gameState.player.x + hitW/2;
      const pT = gameState.player.y - hitH/2;
      const pB = gameState.player.y + hitH/2;

      for (const obs of gameState.obstacles) {
        const oL = obs.x, oR = obs.x + obs.width, oT = obs.y, oB = obs.y + obs.height;
        if (pR > oL && pL < oR && pB > oT && pT < oB) {
          if (gameState.relics.phantomPhase &&
              gameState.relics.phantomPhaseUsed < gameState.upgrades.phantomPhaseLevel) {
            gameState.relics.phantomPhaseUsed++;
            createParticleExplosion(obs.x+obs.width/2, obs.y+obs.height/2, 30, '#fff');
            gameState.obstacles.splice(gameState.obstacles.indexOf(obs),1);
            return;
          } else {
            endGame();
            return;
          }
        }
      }
    }

    function endGame() {
      if (!gameState.player.isAlive) return;
      gameState.gameActive = false;
      gameState.player.isAlive = false;
      createParticleExplosion(gameState.player.x, gameState.player.y, 40, '#00f3ff');

      setTimeout(() => {
        const elapsedMs = Date.now() - gameState.gameStartTime;
        const elapsedSec = (elapsedMs/1000).toFixed(3);
        const minutes = Math.floor(elapsedSec/60);
        const seconds = (elapsedSec%60).toString().padStart(2,'0');

        timeSurvived.textContent = `${minutes}:${seconds}`;
        finalScore.textContent = `${elapsedSec}s`;
        shardsCollected.textContent = gameState.currentRunShards;

        // add run shards to the total (already persisted per‑shard, but we also keep the session total)
        gameState.totalShards += gameState.currentRunShards;

        // update high score if this run is better
        if (elapsedMs > gameState.highScore) {
          gameState.highScore = elapsedMs;
          gameState.highScoreDisplay = elapsedSec;
        }

        if (currentUser) saveUserData();

        gameOverScreen.style.display = 'flex';
        setTimeout(() => gameOverScreen.style.opacity = '1', 50);
      }, 800);
    }

    // ----------------------------------------------------------------------
    // DRAWING
    // ----------------------------------------------------------------------
    function drawPlayerTrail(ctx) {
      gameState.player.trail.forEach((p,i) => {
        ctx.beginPath();
        const alpha = p.alpha * (i / gameState.player.trail.length);
        ctx.fillStyle = `rgba(0,243,255,${alpha*0.5})`;
        ctx.arc(p.x, p.y+10, i/4, 0, Math.PI*2);
        ctx.fill();
      });
    }

    function drawPlayerCharacter(ctx, x, y, size, time) {
      ctx.save();
      ctx.translate(x, y);
      const tilt = (gameState.player.targetX - x) * 0.005;
      ctx.rotate(tilt);
      const breath = Math.sin(time*5)*0.05 + 1;
      if (gameState.timeBend.active) {
        const grad = ctx.createRadialGradient(0,0,0,0,0,size*2.5);
        grad.addColorStop(0,'rgba(0,243,255,0.4)');
        grad.addColorStop(1,'rgba(0,243,255,0)');
        ctx.fillStyle = grad;
        ctx.beginPath(); ctx.arc(0,0,size*2.5,0,Math.PI*2); ctx.fill();
      }
      ctx.beginPath();
      ctx.moveTo(0, -size*0.8*breath);
      ctx.bezierCurveTo(size*0.7, -size*0.4, size*0.6, size*0.6, 0, size*breath);
      ctx.bezierCurveTo(-size*0.6, size*0.6, -size*0.7, -size*0.4, 0, -size*0.8*breath);
      ctx.closePath();
      const bodyGrad = ctx.createRadialGradient(0,0,0,0,0,size);
      bodyGrad.addColorStop(0,'white');
      bodyGrad.addColorStop(0.4,'#00f3ff');
      bodyGrad.addColorStop(1,'#f300ff');
      ctx.fillStyle = bodyGrad;
      ctx.shadowColor = '#00f3ff';
      ctx.shadowBlur = 25;
      ctx.fill();

      ctx.beginPath();
      ctx.arc(0, -size*0.3, size*0.4, 0, Math.PI*2);
      ctx.fillStyle = 'white';
      ctx.shadowColor = 'white';
      ctx.shadowBlur = 15;
      ctx.fill();
      ctx.restore();
    }

    function drawGame() {
      ctx.clearRect(0,0,GAME_WIDTH,GAME_HEIGHT);
      if (gameState.player.isAlive) {
        drawPlayerTrail(ctx);
        drawPlayerCharacter(ctx, gameState.player.x, gameState.player.y,
                            gameState.player.size, Date.now()/1000);
      }
      // obstacles
      gameState.obstacles.forEach(obs => {
        const col = obs.isFracture ? '#00a2ff' : '#ff007a';
        ctx.fillStyle = col;
        ctx.shadowColor = col;
        ctx.shadowBlur = 15;
        ctx.fillRect(obs.x, obs.y, obs.width, obs.height);
      });
      // shards
      gameState.shardsCollectible.forEach(sh => {
        ctx.fillStyle = '#f300ff';
        ctx.shadowColor = '#f300ff';
        ctx.shadowBlur = 15;
        ctx.beginPath(); ctx.arc(sh.x, sh.y, 10, 0, Math.PI*2); ctx.fill();
      });
      // particles
      gameState.particles.forEach((p,i) => {
        p.alpha -= 0.02;
        if (p.alpha <= 0) gameState.particles.splice(i,1);
        p.x += p.vx;
        p.y += p.vy;
        const hexAlpha = Math.floor(p.alpha*255).toString(16).padStart(2,'0');
        ctx.fillStyle = `${p.color}${hexAlpha}`;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
      });
      ctx.shadowBlur = 0;
    }

    // ----------------------------------------------------------------------
    // MAIN LOOP
    // ----------------------------------------------------------------------
    function gameLoop() {
      if (gameState.gameActive) updateGame();
      drawGame();
      requestAnimationFrame(gameLoop);
    }

    // ----------------------------------------------------------------------
    // START EVERYTHING
    // ----------------------------------------------------------------------
    window.addEventListener('load', initGame);
  </script>
</body>
</html>