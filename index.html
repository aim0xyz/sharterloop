<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Shatterloop - Aether Drifter</title>
  <style>
    /* PREVIOUS STYLES ARE THE SAME... */
    * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; }
    body { font-family: 'Segoe UI', 'Helvetica Neue', sans-serif; background: linear-gradient(135deg, #0c0c2d, #000); color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; user-select: none; -webkit-tap-highlight-color: transparent; }
    #gameContainer { position: relative; width: 100%; max-width: 500px; height: 100vh; max-height: 100vh; overflow: hidden; touch-action: none; }
    #gameCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #0a0a20, #000 70%); z-index: 1; }
    #uiContainer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
    .score-display, .shard-count { position: absolute; top: 20px; font-size: 24px; font-weight: bold; pointer-events: none; }
    .score-display { left: 20px; text-shadow: 0 0 10px #00f3ff, 0 0 20px #00f3ff; }
    .shard-count { right: 20px; text-shadow: 0 0 10px #f300ff, 0 0 20px #f300ff; }
    .menu-btn, .auth-btn, .leaderboard-btn { background: linear-gradient(to right, #0047ff, #00a2ff); border: none; border-radius: 50px; color: white; font-size: 22px; font-weight: bold; padding: 15px 40px; margin: 10px 0; width: 80%; max-width: 350px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(0, 162, 255, 0.4); pointer-events: auto; }
    .menu-btn:active, .auth-btn:active, .leaderboard-btn:active { transform: scale(0.95); box-shadow: 0 3px 10px rgba(0, 162, 255, 0.6); }
    .menu-btn.fracture, .auth-btn.google { background: linear-gradient(to right, #7b00ff, #f300ff); box-shadow: 0 5px 15px rgba(243, 0, 255, 0.4); }
    .menu-btn.fracture:active { box-shadow: 0 3px 10px rgba(243, 0, 255, 0.6); }
    .auth-btn.apple { background: #333; box-shadow: 0 5px 15px rgba(50,50,50, 0.4); }

    /* NEW STYLES FOR AUTH AND LEADERBOARD */
    .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; padding: 20px; text-align: center; background: linear-gradient(135deg, #0f0c4d, #000); }
    .hidden { display: none; }
    .screen h1 { font-size: 48px; margin-bottom: 20px; background: linear-gradient(to right, #00f3ff, #f300ff); -webkit-background-clip: text; background-clip: text; color: transparent; text-shadow: 0 0 20px rgba(0, 243, 255, 0.3); letter-spacing: 1px; }
    .screen p { font-size: 18px; max-width: 90%; margin-bottom: 30px; color: #aaa; line-height: 1.5; }
    .auth-form { display: flex; flex-direction: column; width: 100%; max-width: 350px; gap: 15px; }
    .auth-input { background: rgba(255,255,255,0.1); border: 1px solid #00a2ff; border-radius: 50px; padding: 15px 25px; font-size: 18px; color: white; text-align: center; }
    .auth-input::placeholder { color: #888; }
    #authError { color: #ff4757; margin-top: 15px; height: 20px; }
    #leaderboardTable { width: 100%; max-width: 400px; margin-top: 20px; border-collapse: collapse; }
    #leaderboardTable th, #leaderboardTable td { padding: 12px; border-bottom: 1px solid #333; }
    #leaderboardTable th { color: #00a2ff; }
    #leaderboardTable td:first-child { font-weight: bold; color: #f300ff; }
    
  </style>
</head>
<body>
  <div id="gameContainer">
    <canvas id="gameCanvas" class="hidden"></canvas>
    <div id="uiContainer" class="hidden">
        <!-- UI elements from before -->
    </div>

    <!-- AUTH SCREEN -->
    <div id="authScreen" class="screen">
        <h1>SHATTERLOOP</h1>
        <p>Sign in to save your progress and compete on the leaderboard.</p>
        <div class="auth-form">
            <input type="email" id="emailInput" class="auth-input" placeholder="Email">
            <input type="password" id="passwordInput" class="auth-input" placeholder="Password">
            <button id="signupBtn" class="auth-btn">Sign Up with Email</button>
            <button id="loginBtn" class="auth-btn">Log In with Email</button>
            <button id="googleLoginBtn" class="auth-btn google">Sign In with Google</button>
            <button id="appleLoginBtn" class="auth-btn apple">Sign In with Apple</button>
            <p id="authError"></p>
        </div>
    </div>

    <!-- MAIN MENU SCREEN -->
    <div id="menuScreen" class="screen hidden">
        <h1>SHATTERLOOP</h1>
        <p>Welcome, <strong id="playerName">Player</strong>! Guide the Aether Drifter through fractal dimensions. Bend time, collect shards, and master the loop.</p>
        <button class="menu-btn" id="safeModeBtn">SAFE PATH</button>
        <button class="menu-btn fracture" id="fractureModeBtn">FRACTURE PATH</button>
        <button class="menu-btn" id="shopBtn">UPGRADES</button>
        <button class="menu-btn" id="leaderboardBtn">LEADERBOARD</button>
        <button class="menu-btn" id="logoutBtn" style="background: #555;">LOG OUT</button>
    </div>

    <!-- LEADERBOARD SCREEN -->
    <div id="leaderboardScreen" class="screen hidden">
        <h1>LEADERBOARD</h1>
        <table id="leaderboardTable">
            <thead><tr><th>Rank</th><th>Player</th><th>High Score</th></tr></thead>
            <tbody id="leaderboardBody">
                <!-- Ranks will be populated by script -->
            </tbody>
        </table>
        <button class="menu-btn" id="leaderboardBackBtn" style="margin-top: 30px;">Back to Menu</button>
    </div>
    
    <!-- Other screens (shop, game over, etc.) are the same -->
    <div id="shopScreen" class="screen hidden"><!-- ... shop content ... --></div>
    <div id="gameOverScreen" class="screen hidden"><!-- ... game over content ... --></div>
  </div>

  <!-- =============================================================== -->
  <!-- STEP 1: Get these scripts from your Firebase Project Settings   -->
  <!-- =============================================================== -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script>
    // ===============================================================
    // STEP 2: Paste your Firebase config object here
    // ===============================================================
    const firebaseConfig = {
    apiKey: "AIzaSyAqHDZHG626E_U9swnvAbobNxbznWYjByo",
    authDomain: "shatterloop-a7640.firebaseapp.com",
    projectId: "shatterloop-a7640",
    storageBucket: "shatterloop-a7640.firebasestorage.app",
    messagingSenderId: "568996461864",
    appId: "1:568996461864:web:92fc542d589667491f241d",
    measurementId: "G-HRZ1HHS754"
  };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ===============================================================
    // Firebase Logic
    // ===============================================================
    let currentUser = null;
    let highscore = 0;

    const authScreen = document.getElementById('authScreen');
    const menuScreen = document.getElementById('menuScreen');
    const leaderboardScreen = document.getElementById('leaderboardScreen');
    const playerNameEl = document.getElementById('playerName');
    const authErrorEl = document.getElementById('authError');

    // Listen for auth state changes
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        // User is signed in
        currentUser = user;
        await loadUserData();
        showScreen('menu');
        playerNameEl.textContent = user.displayName || user.email.split('@')[0];
      } else {
        // User is signed out
        currentUser = null;
        highscore = 0;
        showScreen('auth');
      }
    });

    // Sign up with Email
    document.getElementById('signupBtn').addEventListener('click', () => {
      const email = document.getElementById('emailInput').value;
      const password = document.getElementById('passwordInput').value;
      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
           userCredential.user.updateProfile({ displayName: email.split('@')[0] });
        })
        .catch(error => { authErrorEl.textContent = error.message; });
    });

    // Login with Email
     document.getElementById('loginBtn').addEventListener('click', () => {
      const email = document.getElementById('emailInput').value;
      const password = document.getElementById('passwordInput').value;
      auth.signInWithEmailAndPassword(email, password)
        .catch(error => { authErrorEl.textContent = error.message; });
    });
    
    // Login with Google
    document.getElementById('googleLoginBtn').addEventListener('click', () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(error => { authErrorEl.textContent = error.message; });
    });

    // Login with Apple
    document.getElementById('appleLoginBtn').addEventListener('click', () => {
      const provider = new firebase.auth.OAuthProvider('apple.com');
      auth.signInWithPopup(provider).catch(error => { authErrorEl.textContent = error.message; });
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      auth.signOut();
    });

    // Load user data from Firestore
    async function loadUserData() {
        if (!currentUser) return;
        const userRef = db.collection('users').doc(currentUser.uid);
        const doc = await userRef.get();
        if (doc.exists) {
            const data = doc.data();
            gameState.totalShards = data.totalShards || 0;
            highscore = data.highscore || 0;
            gameState.upgrades = data.upgrades || { timeBendLevel: 1, shardMagnetLevel: 0 };
            gameState.relics.phantomPhase = data.phantomPhase || false;
        } else {
            // New user, create their document
            await userRef.set({
                email: currentUser.email,
                displayName: currentUser.displayName || currentUser.email.split('@')[0],
                totalShards: 0,
                highscore: 0,
                upgrades: { timeBendLevel: 1, shardMagnetLevel: 0 },
                phantomPhase: false,
            });
        }
    }

    // Save game data
    async function saveGameData() {
        if (!currentUser) return;
        const userRef = db.collection('users').doc(currentUser.uid);
        
        const newHighscore = Math.max(highscore, gameState.score);
        
        await userRef.set({
            totalShards: gameState.totalShards,
            highscore: newHighscore,
            upgrades: gameState.upgrades,
            phantomPhase: gameState.relics.phantomPhase,
        }, { merge: true });
        
        highscore = newHighscore; // Update local highscore
    }
    
    // Leaderboard Logic
    document.getElementById('leaderboardBtn').addEventListener('click', showLeaderboard);
    document.getElementById('leaderboardBackBtn').addEventListener('click', () => showScreen('menu'));

    async function showLeaderboard() {
        showScreen('leaderboard');
        const leaderboardBody = document.getElementById('leaderboardBody');
        leaderboardBody.innerHTML = '<tr><td colspan="3">Loading...</td></tr>';

        const querySnapshot = await db.collection('users')
            .orderBy('highscore', 'desc')
            .limit(10)
            .get();
            
        leaderboardBody.innerHTML = '';
        let rank = 1;
        querySnapshot.forEach(doc => {
            const data = doc.data();
            const row = `<tr><td>${rank++}</td><td>${data.displayName}</td><td>${data.highscore}</td></tr>`;
            leaderboardBody.innerHTML += row;
        });
    }

    function showScreen(screenName) {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById(`${screenName}Screen`).classList.remove('hidden');
    }
    
    // ===============================================================
    // Game Logic (Modified to include saving data)
    // ===============================================================
    // (The entire previous game logic script goes here, with one key change...)
    
    // In the `endGame` function, right after the totalShards are updated,
    // add the call to save the data.
    
    function endGame() {
        if (!gameState.player.isAlive) return;
        gameState.gameActive = false;
        gameState.player.isAlive = false;
        createParticleExplosion(gameState.player.x, gameState.player.y, 40, '#00f3ff');
        
        setTimeout(async () => { // Make this function async
            const time = Math.floor((Date.now() - gameState.startTime) / 1000);
            timeSurvived.textContent = `${Math.floor(time/60)}:${(time%60).toString().padStart(2, '0')}`;
            finalScore.textContent = gameState.score;
            shardsCollected.textContent = gameState.currentRunShards;
            gameState.totalShards += gameState.currentRunShards;
            
            await saveGameData(); // *** NEW: SAVE DATA ON GAME OVER ***

            // Show game over screen and hide the game canvas/UI
            showScreen('gameOver');
            document.getElementById('gameCanvas').classList.add('hidden');
            document.getElementById('uiContainer').classList.add('hidden');

        }, 800);
    }
    
    function startGame(mode) {
        // Original startGame logic...
        gameState.mode = mode;
        resetGameState();
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById('gameCanvas').classList.remove('hidden');
        document.getElementById('uiContainer').classList.remove('hidden');
    }

    // (The rest of your game code: resetGameState, updateGame, drawGame, etc. would be here)

  </script>
</body>
</html>